#!/usr/bin/env node
'use strict'

const updater = require('../');

var argv = require('yargs')
  .describe('image', 'Docker image and tag')
  .describe('container-name', 'Container to update in the ECS Task Definition')
  .describe('service-name', 'ECS Service to update')
  .describe('task-definition-family', 'Task Definition Family create the new Task Definition in')
  .describe('cluster-arn', 'Arn of the ECS Cluster for which the Service exists on. Used in conjunction with service-name')
  .describe('output-arn-only', 'Output the new Task Definition Arn only')
  .demand([ 'image', 'container-name' ])
  .implies('service-name', 'cluster-arn')
  .conflicts('service-name', 'task-definition-family')
  .conflicts('task-definition-family', 'service-name')
  .argv;

var options = {
  clusterArn: argv.clusterArn,
  containerName: argv.containerName,
  image: argv.image
}

if (argv.serviceName) options.serviceName = argv.serviceName;
if (argv.taskDefinitionFamily) options.taskDefinitionFamily = argv.taskDefinitionFamily;

updater(options, (err, taskDefinitionArn) => {
  if (err) throw err;

  if (argv.outputArnOnly) {
    console.log(taskDefinitionArn);
    return;
  }

  console.log(`Created Task Definition: ${taskDefinitionArn}`);

  if (argv.serviceName) {
    console.log(`Service ${argv.serviceName} has been updated to use the new Task Definition`);
    return;
  }
});
